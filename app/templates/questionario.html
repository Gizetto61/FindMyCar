{% extends 'base.html' %}

{% block title %}FindMyCar - Teste de Recomendação{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/questionario.css') }}">
{% endblock %}

{% block content %}
<div id="app">
    <main class="container mx-auto my-8 max-w-4xl bg-white p-8 rounded-xl shadow-lg text-center">

        <div v-if="isLoading" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center rounded-xl z-10">
            <svg class="animate-spin h-12 w-12 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-    8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h3 class="text-xl font-semibold text-gray-700">Calculando suas recomendações...</h3>
            <p class="text-gray-500">Por favor, aguarde um momento.</p>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 mb-4">Teste de Recomendação</h1>
        <h2 class="text-2xl text-gray-600 mb-12">[[ perguntaAtual.desc_pergunta ]]</h2>

        <div class="w-full bg-gray-200 rounded-full h-4 mb-16">
            <div class="bg-indigo-600 h-4 rounded-full transition-all duration-500 ease-in-out" 
                 :style="{ width: progressPercentage + '%' }">
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-5">
            <button v-for="n in 5"
                    :key="n"
                    @click="responderPergunta(n)"
                    :class="getOptionColorClass(n)"
                    class="flex flex-col justify-center items-center h-32 p-4 text-lg font-medium bg-white border-2 rounded-xl cursor-pointer transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                
                <span>[[ getOptionDescription(n) ]]</span>
            </button>
        </div>
    </main>
</div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script>
    new Vue({
        el: "#app",
        delimiters: ["[[", "]]"],

        data() {
          return {
            perguntas: [
              {
                numero_pergunta: 1,
                desc_pergunta:
                  "O quanto o conforto interno importa na sua decisão?",
                resposta_pergunta: 0,
              },
              {
                numero_pergunta: 2,
                desc_pergunta:
                  "Qual a sua prioridade em termos de economia de combustível?",
                resposta_pergunta: 0,
              },
              {
                numero_pergunta: 3,
                desc_pergunta: "Qual a importância do espaço de seu carro?",
                resposta_pergunta: 0,
              },
              {
                numero_pergunta: 4,
                desc_pergunta:
                  "Qual a importância do preço de compra de um carro novo?",
                resposta_pergunta: 0,
              },
              {
                numero_pergunta: 5,
                desc_pergunta: "Qual a importância do preço de manutenção?",
                resposta_pergunta: 0,
              },
            ],
            i_pergunta_atual: 0,
            isLoading: false
          };
        },
        computed: {
          perguntaAtual() {
            if (this.i_pergunta_atual >= this.perguntas.length) {
              return this.perguntas[this.perguntas.length - 1];
            }
            return this.perguntas[this.i_pergunta_atual];
          },
          progressPercentage() {
            if (this.perguntas.length === 0) return 0;
            return (this.i_pergunta_atual / this.perguntas.length) * 100;
          },
          progressLabel() {
            return `${this.i_pergunta_atual + 1}/${this.perguntas.length}`;
          },
        },
        methods: {
            responderPergunta: function (resposta) {
                this.perguntas[this.i_pergunta_atual].resposta_pergunta = resposta;

                if (this.i_pergunta_atual < this.perguntas.length - 1) {
                    this.i_pergunta_atual++;
                } else {
                    this.isLoading = true;
                    const payload = {
                        conforto: this.perguntas[0].resposta_pergunta,
                        consumo: this.perguntas[1].resposta_pergunta,
                        tamanho: this.perguntas[2].resposta_pergunta,
                        preco: this.perguntas[3].resposta_pergunta,
                        manutencao: this.perguntas[4].resposta_pergunta,
                    };
                    fetch("/api/recomendar", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", },
                        body: JSON.stringify(payload),
                    })
                    .then(response => response.json())
                    .then(data => { window.location.href = "/recomendacao"; })
                    .catch(error => { 
                        console.error("Erro:", error); 
                        this.isLoading = false;
                    });
                }
            },

            getOptionColorClass(value) {
                const colorClasses = {
                    1: 'border-red-500 text-red-600',
                    2: 'border-orange-500 text-orange-600',
                    3: 'border-yellow-500 text-yellow-600',
                    4: 'border-lime-500 text-lime-600',
                    5: 'border-green-500 text-green-600',
                };
                return colorClasses[value] || 'border-gray-300 text-gray-700';
            },
          getOptionColorClass(value) {
            const classes = {
              1: "red",
              2: "orange",
              3: "yellow",
              4: "lightgreen",
              5: "green",
            };
            return classes[value];
          },
          getOptionDescription(value) {
            const descriptions = {
              1: "Nada importante",
              2: "Pouco importante",
              3: "Neutro",
              4: "Importante",
              5: "Muito importante",
            };
            return descriptions[value];
          },
        },
      });
</script>
{% endblock %}