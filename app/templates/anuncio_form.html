{% extends "base.html" %}
{% block content %}

<section class="min-h-[85vh] py-16 px-6 flex flex-col items-center text-gray-800">
  <div id="app" class="max-w-4xl w-full bg-white rounded-2xl shadow-xl p-10">
    <h1 class="text-4xl font-bold text-center text-gray-900 mb-6">Anuncie seu carro</h1>
    <p class="text-center text-gray-500 mb-10 text-lg">
      Preencha os campos abaixo para anunciar seu veículo no <strong>FindMyCar</strong>.
    </p>

    <form @submit.prevent="enviarAnuncio" enctype="multipart/form-data" class="space-y-6">

    <div>
      <label class="block text-gray-700 font-medium mb-1">Modelo do Carro</label>
      <select v-model="form.carro_id" name="carro_id" required
              class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="" disabled>Selecione o modelo do seu carro...</option>

          {% for carro in lista_de_carros %}
              <option value="{{ carro.id }}">{{ carro.marca }} {{ carro.modelo }}</option>
          {% endfor %}

      </select>
    </div>

    <div class="grid grid-cols-2 gap-6">
    <div>
        <label class="block text-gray-700 font-medium mb-1">Ano de Fabricação</label>
        <select v-model="form.ano_fabricacao" required class="w-full p-3 border border-gray-300 rounded-lg ...">
            <option value="">Selecione...</option>
            {% for ano in range(2026, 1959, -1) %}
                <option value="{{ ano }}">{{ ano }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label class="block text-gray-700 font-medium mb-1">Ano do Modelo</label>
        <select v-model="form.ano_modelo" required class="w-full p-3 border border-gray-300 rounded-lg ...">
            <option value="">Selecione...</option>
            {% for ano in range(2026, 1959, -1) %}
                <option value="{{ ano }}">{{ ano }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div>
    <label class="block text-gray-700 font-medium mb-1">Cor</label>
    <select v-model="form.cor" required
            class="w-full p-3 border border-gray-300 rounded-lg ...">
        <option value="">Selecione...</option>
        <option value="Branco">Branco</option>
        <option value="Preto">Preto</option>
        <option value="Prata">Prata</option>
        <option value="Cinza">Cinza</option>
        <option value="Vermelho">Vermelho</option>
        <option value="Azul">Azul</option>
        <option value="Verde">Verde</option>
        <option value="Amarelo">Amarelo</option>
        <option value="Marrom">Marrom</option>
        <option value="Outra">Outra</option>
    </select>
</div>

<div>
    <label for="precoAnuncio" class="block text-gray-700 font-medium mb-1">Preço</label>
    <div class="relative">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">R$</span>
        <input id="precoAnuncio" type="text" required placeholder="0,00"
               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>
</div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Quilometragem</label>
        <input v-model="form.km" type="number" required placeholder="Ex: 45.000"
               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" />
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Transmissão</label>
        <select v-model="form.transmissao" required
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">Selecione...</option>
          <option value="Manual">Manual</option>
          <option value="Automático">Automático</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Condição do carro</label>
        <select v-model="form.condicao" required
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">Selecione...</option>
          <option value="Novo">Novo</option>
          <option value="Seminovo">Seminovo</option>
          <option value="Para-peças">Para peças</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Observações</label>
        <textarea v-model="form.observacoes" rows="4" placeholder="Detalhes adicionais..."
                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Telefone para contato</label>
        <div class="flex items-center gap-2 mb-2">
          <input type="checkbox" v-model="usarTelefonePerfil" id="usar-perfil" />
          <label for="usar-perfil" class="text-gray-600 text-sm">Usar telefone do perfil</label>
        </div>
        <input ref="telefoneInput" v-model="form.telefone" :disabled="usarTelefonePerfil"
               :placeholder="usarTelefonePerfil ? 'Usando telefone do perfil' : '(00) 00000-0000'"
               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <label class="block text-gray-700 font-medium mb-1">Estado</label>
          <select v-model="form.estado" required
                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-900">
            <option value="">Selecione...</option>
            <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option>
            <option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option>
            <option>MT</option><option>MS</option><option>MG</option><option>PA</option><option>PB</option>
            <option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option>
            <option>RS</option><option>RO</option><option>RR</option><option>SC</option><option>SP</option>
            <option>SE</option><option>TO</option>
          </select>
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-1">Cidade</label>
          <input v-model="form.cidade" required placeholder="Digite sua cidade"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Endereço (opcional)</label>
        <input v-model="form.endereco" placeholder="Rua, número, bairro..."
               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Fotos do carro</label>
        <input type="file" accept="image/jpeg, image/png" multiple @change="handleFiles"
               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" />
        <p class="text-sm text-gray-500 mt-1">Máximo de 4 imagens (.jpg, .png)</p>

        <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
          <div v-for="(img, i) in previews" :key="i" class="relative group">
            <img :src="img" class="w-full h-32 object-cover rounded-lg shadow" />
            <button type="button" @click="removeImage(i)"
                    class="absolute -top-2 -right-2 bg-white text-gray-700 rounded-full p-1 shadow opacity-0 group-hover:opacity-100 transition">
              ✕
            </button>
          </div>
        </div>

        <p v-if="erroImagens" class="text-sm text-red-600 mt-2">{{ erroImagens }}</p>
      </div>

      <div class="pt-4">
        <button type="submit"
                class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
          Enviar anúncio
        </button>
      </div>

    </form>
  </div>
</section>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/imask"></script>

<script>
const { createApp, ref, onMounted, watch } = Vue;

createApp({
  setup() {
    const form = ref({
      carro_id: "",
      ano_fabricacao: "",
      ano_modelo: "",
      cor: "",
      preco: "",
      km: "",
      transmissao: "",
      condicao: "",
      observacoes: "",
      telefone: "",
      estado: "",
      cidade: "",
      endereco: "",
    });

    const precoInput = ref(null);

 
    onMounted(() => {
        // Inicializa a máscara do telefone (código existente)
        // ...

        // 3. INICIALIZA A MÁSCARA DE MOEDA NO INPUT DE PREÇO
        const precoElement = document.getElementById('precoAnuncio');
        if (precoElement) {
            const precoMask = IMask(precoElement, {
                mask: Number, // Permite apenas números
                scale: 2,     // Duas casas decimais
                thousandsSeparator: '.', // Separador de milhar
                padFractionalZeros: true, // Adiciona ",00" se não houver centavos
                normalizeZeros: true,
                radix: ',', // Separador decimal
                mapToRadix: ['.'],
            });

            // Ouve as mudanças e atualiza o 'form.preco' com o valor numérico (sem máscara)
            precoMask.on('accept', () => {
                form.value.preco = precoMask.unmaskedValue;
            });
        }
    });

    const usarTelefonePerfil = ref(false);
    const telefoneInput = ref(null);

    // O array 'previews' já contém as strings base64, então não precisamos de um array 'arquivos' separado.
    const imagensBase64 = ref([]); 
    const erroImagens = ref("");
 
    onMounted(() => {
        if (telefoneInput.value) {
            IMask(telefoneInput.value, {
                mask: [
                    { mask: '(00) 0000-0000' },
                    { mask: '(00) 00000-0000' }
                ]
            });
        }
    });

    watch(usarTelefonePerfil, (val) => {
        if (val) form.value.telefone = "";
    });

    function handleFiles(e) {
        const files = Array.from(e.target.files);
        erroImagens.value = "";

        if (files.length + imagensBase64.value.length > 4) {
            erroImagens.value = "Você pode enviar no máximo 4 imagens.";
            e.target.value = ""; // Limpa o input de arquivo
            return;
        }

        files.forEach((file) => {
            if (!file.type.startsWith("image/")) {
                erroImagens.value = "Apenas arquivos de imagem são permitidos.";
                return;
            }
            const reader = new FileReader();
            
            // Quando a leitura do arquivo estiver completa...
            reader.onload = (ev) => {
                // ...adicionamos a string base64 diretamente ao nosso array.
                imagensBase64.value.push(ev.target.result); 
            };
            
            // Inicia a leitura do arquivo, que o converte para uma string Data URL (base64)
            reader.readAsDataURL(file);
        });
    }

    function removeImage(index) {
        // Remove a imagem tanto do array de dados quanto da pré-visualização.
        imagensBase64.value.splice(index, 1);
    }

    function validarTelefone(telefone) {
        if (!telefone) return true; 
        const numeros = telefone.replace(/\D/g, "");
        return numeros.length === 10 || numeros.length === 11;
    }

    // A pré-visualização agora usa diretamente o array de strings base64.
    const previews = imagensBase64;

    function enviarAnuncio() {
        if (imagensBase64.value.length === 0) {
            erroImagens.value = "Envie pelo menos uma imagem.";
            return;
        }

        if (!validarTelefone(form.value.telefone) && !usarTelefonePerfil.value) {
            alert("Digite um telefone válido com DDD (10 ou 11 dígitos).");
            return;
        }

        // 1. Monta o objeto JSON para envio
        const payload = {
            ...form.value, // Copia todos os campos do formulário
            imagens: imagensBase64.value, // Adiciona o array de strings base64
        };
        
        // Trata o campo telefone
        if (usarTelefonePerfil.value) {
            payload.telefone = "usar_perfil"; // Envia um sinalizador para o backend
        } else {
            payload.telefone = form.value.telefone.replace(/\D/g, "");
        }

        // 2. Envia o JSON para o backend
        fetch("/api/anunciar", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json', // O cabeçalho agora é JSON
            },
            body: JSON.stringify(payload), // O corpo é a string JSON do nosso objeto
        })
        .then((res) => {
            if (!res.ok) throw new Error('Falha na resposta do servidor.');
            return res.json();
        })
        .then((result) => {
            // 1. Pega o ID do anúncio da resposta da API
            const novoAnuncioId = result.anuncio_id;
            
            // 2. Monta a URL para a página do novo anúncio
            const urlDestino = `/anuncio/${novoAnuncioId}`;
            
            // 3. Redireciona o usuário para a nova página
            window.location.href = urlDestino;
        })
        .catch((err) => {
            console.error("Erro ao enviar:", err);
            alert("Erro ao enviar o anúncio. Tente novamente.");
        });
    }

    return {
      form,
      usarTelefonePerfil,
      telefoneInput,
      previews,
      erroImagens,
      handleFiles,
      removeImage,
      enviarAnuncio,
    };
  },
}).mount("#app");
</script>

{% endblock %}
